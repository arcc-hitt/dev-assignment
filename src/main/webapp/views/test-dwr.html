<!DOCTYPE html>
<html>
<head>
  <title>DWR Service Test</title>
  <script type='text/javascript' src='/dwr/engine.js'></script>
  <script type='text/javascript' src='/dwr/util.js'></script>
  <script type='text/javascript' src='/dwr/interface/prefixService.js'></script>
  <script type='text/javascript' src='/dwr/interface/itemService.js'></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .test-section { margin-bottom: 30px; border: 1px solid #ccc; padding: 15px; }
    .success { color: green; }
    .error { color: red; }
    .log { background: #f5f5f5; padding: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
<h1>DWR Service Test Page</h1>

<div class="test-section">
  <h3>DWR Status</h3>
  <div id="dwrStatus">Checking...</div>
</div>

<div class="test-section">
  <h3>Prefix Service Test</h3>
  <button onclick="testPrefixService()">Test Prefix Service</button>
  <div id="prefixResult"></div>
</div>

<div class="test-section">
  <h3>Item Service Test</h3>
  <button onclick="testItemService()">Test Item Service</button>
  <div id="itemResult"></div>
</div>

<div class="test-section">
  <h3>Add Prefix Test</h3>
  <input type="text" id="testPrefix" placeholder="Enter test prefix" value="Test123">
  <button onclick="testAddPrefix()">Add Test Prefix</button>
  <div id="addResult"></div>
</div>

<div class="test-section">
  <h3>Debug Log</h3>
  <div id="debugLog" class="log"></div>
  <button onclick="clearLog()">Clear Log</button>
</div>

<script>
  function log(message) {
    var timestamp = new Date().toLocaleTimeString();
    var logDiv = document.getElementById('debugLog');
    logDiv.innerHTML = '[' + timestamp + '] ' + message + '<br>' + logDiv.innerHTML;
    console.log('[DWR Test]', message);
  }

  function clearLog() {
    document.getElementById('debugLog').innerHTML = '';
  }

  // Check DWR status
  window.addEventListener('load', function() {
    setTimeout(function() {
      var statusDiv = document.getElementById('dwrStatus');

      if (typeof dwr === 'undefined') {
        statusDiv.innerHTML = '<span class="error">❌ DWR engine not loaded</span>';
        log('ERROR: DWR engine not loaded');
        return;
      }

      log('DWR engine loaded successfully');

      if (typeof prefixService === 'undefined') {
        statusDiv.innerHTML = '<span class="error">❌ prefixService not available</span>';
        log('ERROR: prefixService not available');
      } else {
        log('prefixService available');
      }

      if (typeof itemService === 'undefined') {
        statusDiv.innerHTML += '<br><span class="error">❌ itemService not available</span>';
        log('ERROR: itemService not available');
      } else {
        log('itemService available');
      }

      if (typeof prefixService !== 'undefined' && typeof itemService !== 'undefined') {
        statusDiv.innerHTML = '<span class="success">✅ All DWR services loaded successfully</span>';

        // Setup DWR
        dwr.engine.setAsync(true);
        dwr.engine.setErrorHandler(function(msg, ex) {
          log('DWR Engine Error: ' + msg);
          console.error('DWR Error:', msg, ex);
        });

        log('DWR engine configured');
      } else {
        statusDiv.innerHTML += '<br><span class="error">❌ Some services missing</span>';
      }
    }, 1000);
  });

  function testPrefixService() {
    var resultDiv = document.getElementById('prefixResult');
    resultDiv.innerHTML = 'Testing...';
    log('Testing prefixService.count()...');

    try {
      prefixService.count("", "", "", {
        callback: function(count) {
          log('prefixService.count() successful: ' + count);
          resultDiv.innerHTML = '<span class="success">✅ Count: ' + count + '</span>';

          // Now test getPrefixes
          log('Testing prefixService.getPrefixes()...');
          prefixService.getPrefixes("", "", "", 1, 5, {
            callback: function(list) {
              log('prefixService.getPrefixes() successful: ' + (list ? list.length : 0) + ' items');
              resultDiv.innerHTML += '<br><span class="success">✅ Got ' + (list ? list.length : 0) + ' prefixes</span>';
              if (list && list.length > 0) {
                resultDiv.innerHTML += '<br>First item: ' + JSON.stringify(list[0]);
              }
            },
            errorHandler: function(msg, ex) {
              log('prefixService.getPrefixes() error: ' + msg);
              resultDiv.innerHTML += '<br><span class="error">❌ getPrefixes failed: ' + msg + '</span>';
            }
          });
        },
        errorHandler: function(msg, ex) {
          log('prefixService.count() error: ' + msg);
          resultDiv.innerHTML = '<span class="error">❌ Count failed: ' + msg + '</span>';
        },
        timeout: 10000
      });
    } catch (e) {
      log('Exception testing prefixService: ' + e.message);
      resultDiv.innerHTML = '<span class="error">❌ Exception: ' + e.message + '</span>';
    }
  }

  function testItemService() {
    var resultDiv = document.getElementById('itemResult');
    resultDiv.innerHTML = 'Testing...';
    log('Testing itemService.getItemCount()...');

    try {
      itemService.getItemCount("", "", "", "", "", {
        callback: function(count) {
          log('itemService.getItemCount() successful: ' + count);
          resultDiv.innerHTML = '<span class="success">✅ Count: ' + count + '</span>';

          // Now test getItems
          log('Testing itemService.getItems()...');
          itemService.getItems("", "", "", "", "", 1, 5, {
            callback: function(list) {
              log('itemService.getItems() successful: ' + (list ? list.length : 0) + ' items');
              resultDiv.innerHTML += '<br><span class="success">✅ Got ' + (list ? list.length : 0) + ' items</span>';
              if (list && list.length > 0) {
                resultDiv.innerHTML += '<br>First item: ' + JSON.stringify(list[0]);
              }
            },
            errorHandler: function(msg, ex) {
              log('itemService.getItems() error: ' + msg);
              resultDiv.innerHTML += '<br><span class="error">❌ getItems failed: ' + msg + '</span>';
            }
          });
        },
        errorHandler: function(msg, ex) {
          log('itemService.getItemCount() error: ' + msg);
          resultDiv.innerHTML = '<span class="error">❌ Count failed: ' + msg + '</span>';
        },
        timeout: 10000
      });
    } catch (e) {
      log('Exception testing itemService: ' + e.message);
      resultDiv.innerHTML = '<span class="error">❌ Exception: ' + e.message + '</span>';
    }
  }

  function testAddPrefix() {
    var resultDiv = document.getElementById('addResult');
    var prefixValue = document.getElementById('testPrefix').value.trim();

    if (!prefixValue) {
      resultDiv.innerHTML = '<span class="error">❌ Please enter a test prefix</span>';
      return;
    }

    resultDiv.innerHTML = 'Adding...';
    log('Testing prefixService.create() with: ' + prefixValue);

    var testData = {
      searchPrefix: prefixValue,
      gender: 'Male',
      prefixOf: 'Test'
    };

    try {
      prefixService.create(testData, {
        callback: function(result) {
          log('prefixService.create() successful: ' + JSON.stringify(result));
          resultDiv.innerHTML = '<span class="success">✅ Added successfully</span>';

          // Refresh the count
          setTimeout(function() {
            testPrefixService();
          }, 1000);
        },
        errorHandler: function(msg, ex) {
          log('prefixService.create() error: ' + msg);
          resultDiv.innerHTML = '<span class="error">❌ Add failed: ' + msg + '</span>';
        },
        timeout: 10000
      });
    } catch (e) {
      log('Exception adding prefix: ' + e.message);
      resultDiv.innerHTML = '<span class="error">❌ Exception: ' + e.message + '</span>';
    }
  }
</script>
</body>
</html>